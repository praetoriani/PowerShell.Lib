# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json

# =============================================================================
# GITHUB ACTIONS WORKFLOW FOR CONTEXT MENU SWITCHER RELEASES
# =============================================================================
# This file defines an automated workflow that runs when a tag starting 
# with "cms-" is created (e.g. cms-v1.0.1)

name: Context Menu Switcher Release

# TRIGGER CONFIGURATION
# Defines when this workflow should be executed
on:
  push:
    tags:
      - 'cms-*'  # Workflow starts only for tags beginning with "cms-"
                 # Examples: cms-v1.0.1, cms-v2.0.0, cms-beta-1

# PERMISSIONS
# GitHub Actions requires explicit permission to create releases
permissions:
  contents: write    # Allows creating and editing repository contents

# JOB DEFINITION
# A workflow can contain multiple jobs, here we have only one
jobs:
  release:
    runs-on: ubuntu-latest    # The workflow runs on an Ubuntu Linux server
    
    # ADDITIONAL SECURITY CHECK
    # Double-check that only cms-tags trigger this workflow
    if: startsWith(github.ref, 'refs/tags/cms-')
    
    # WORKFLOW STEPS
    # Each step is executed sequentially
    steps:
      # STEP 1: Download repository code
      # GitHub Actions runs on a fresh server and needs access to your code
      - name: Checkout repository
        uses: actions/checkout@v4    # Official GitHub Action for code download
        # After this step, all your repository files are available

      # STEP 2: Create release package
      # Only the Context Menu Switcher folder is packed into a ZIP package
      - name: Create Context Menu Switcher release package
        run: |
          # Debug output - displayed in the Actions log
          echo "üöÄ Starting release package creation for Context Menu Switcher"
          
          # Create temporary folder for the release
          mkdir -p release-temp/Context-Menu-Switcher
          echo "üìÅ Temporary release folder created"
          
          # IMPORTANT: Copy all files from the Context Menu Switcher folder
          # Folder name contains spaces, therefore quotes are necessary
          cp -r "Context Menu Switcher"/* release-temp/Context-Menu-Switcher/
          echo "üìã Context Menu Switcher files copied:"
          ls -la "Context Menu Switcher"/
          
          # Change to temporary folder
          cd release-temp
          
          # Create ZIP file with all Context Menu Switcher files
          # -r = recursive (include all subdirectories)
          zip -r ../context-menu-switcher-release.zip Context-Menu-Switcher/
          
          # Return to root directory
          cd ..
          
          # Confirmation and display ZIP file size
          echo "‚úÖ ZIP file created:"
          ls -lh context-menu-switcher-release.zip

      # STEP 3: Create GitHub release
      # This is the most important step - the actual release is created here
      - name: Create GitHub release with assets
        uses: softprops/action-gh-release@v1    # Proven third-party action for releases
        with:
          # RELEASE TITLE
          # Uses the tag name (e.g. "Context Menu Switcher cms-v1.0.1")
          name: Context Menu Switcher ${{ github.ref_name }}
          
          # RELEASE DESCRIPTION (Markdown format supported)
          body: |
            # üéØ Context Menu Switcher Release ${{ github.ref_name }}
            
            This release contains **exclusively** the files for the Context Menu Switcher.
            
            ## üì¶ Package Contents:
            - ‚úÖ **Context-Menu-Switcher.ps1** - Main PowerShell script
            - ‚úÖ **ReadMe.md** - Detailed documentation and instructions
            - ‚úÖ **en-us.json** - English language file
            
            ## üöÄ Installation:
            1. Download the ZIP file
            2. Extract to desired folder
            3. Open PowerShell as Administrator
            4. Run script: `.\Context-Menu-Switcher.ps1`
            
            ## ‚ö†Ô∏è System Requirements:
            - Windows 10/11
            - PowerShell 5.1 or higher
            - Administrator privileges required
            
            ## üîÑ Changelog:
            - Automatically generated on ${{ github.event.head_commit.timestamp }}
            - Commit: ${{ github.sha }}
            
            ---
            *This release was automatically created by GitHub Actions.*
          
          # RELEASE SETTINGS
          files: context-menu-switcher-release.zip    # The ZIP file as download asset
          draft: false          # false = Release is published immediately
          prerelease: false     # false = Normal release (not marked as beta)
          
          # ERROR HANDLING
          fail_on_unmatched_files: true    # Workflow fails if ZIP file doesn't exist
          
        # AUTHENTICATION
        # GitHub Actions automatically uses GITHUB_TOKEN for authentication
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      # STEP 4: Confirm success (Optional, but helpful for debugging)
      - name: Confirm release creation
        run: |
          echo "üéâ Context Menu Switcher release successfully created!"
          echo "üìä Release Info:"
          echo "   - Tag: ${{ github.ref_name }}"
          echo "   - Repository: ${{ github.repository }}"
          echo "   - Commit: ${{ github.sha }}"
          echo "   - Created on: $(date)"
          echo ""
          echo "üåê Release available at:"
          echo "   https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"